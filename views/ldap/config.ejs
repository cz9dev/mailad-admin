<% const buttons=` <button type="submit" form="ldapForm" class="btn btn-primary me-2">
    <i class="bi bi-check-circle"></i> Guardar
    </button>
    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal"
        data-bs-target="#testConnectionModal">
        <i class="bi bi-plug"></i> Probar Conexión
    </button>
    `;
    %>

    <form id="ldapForm" method="POST" action="/ldap">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="uri" class="form-label">URI del Servidor</label>
                    <input type="text" class="form-control" id="uri" name="uri" value="<%= config.uri || '' %>"
                        required>
                    <div class="form-text">Ej: ldap://dominio:389 o ldaps://dominio:636</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="base" class="form-label">Base DN</label>
                    <input type="text" class="form-control" id="base" name="base" value="<%= config.base || '' %>"
                        required>
                    <div class="form-text">Ej: dc=midominio,dc=com</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="binddn" class="form-label">Bind DN</label>
                    <input type="text" class="form-control" id="binddn" name="binddn" value="<%= config.binddn || '' %>"
                        required>
                    <div class="form-text">Usuario para conectarse al LDAP/AD</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="bindpw" class="form-label">Bind Password</label>
                    <input type="password" class="form-control" id="bindpw" name="bindpw"
                        value="<%= config.bindpw || '' %>" required>
                    <div class="form-text">Contraseña del usuario</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="version" class="form-label">Versión LDAP</label>
                    <input type="number" class="form-control" id="version" name="version"
                        value="<%= config.version || '3' %>" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="timeout" class="form-label">Timeout (segundos)</label>
                    <input type="number" class="form-control" id="timeout" name="timeout"
                        value="<%= config.timeout || '30' %>" required>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="mb-3">
                    <label for="filter" class="form-label">Filtro de Búsqueda</label>
                    <input type="text" class="form-control" id="filter" name="filter"
                        value="<%= config.filter || '(objectClass=*)' %>" required>
                    <div class="form-text">Filtro LDAP para buscar usuarios</div>
                </div>
            </div>
        </div>

        <% if (typeof errors !=='undefined' && errors.length> 0) { %>
            <div class="alert alert-danger">
                <ul class="mb-0">
                    <% errors.forEach(function(error) { %>
                        <li>
                            <%= error %>
                        </li>
                        <% }); %>
                </ul>
            </div>
            <% } %>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="/" class="btn btn-secondary me-md-2">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Guardar Configuración</button>
                </div>
    </form>

    <!-- Modal para probar conexión -->
    <div class="modal fade" id="testConnectionModal" tabindex="-1" aria-labelledby="testConnectionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="testConnectionModalLabel">Probar Conexión LDAP/AD</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que quieres probar la conexión con la configuración actual?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <form action="/ldap/test" method="POST">
                        <button type="submit" class="btn btn-primary">Probar Conexión</button>
                    </form>
                </div>
            </div>
        </div>
    </div>